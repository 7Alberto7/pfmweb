{% extends "MIWIntranetBundle:Default:base.html.twig" %}

{% block commonup%}

<ul class="breadcrumb" style="margin-bottom: 5px;">
    <li><a href="{{path('intranet_home')}}">WePlay</a></li>
    <li><a href="{{path('intranet_games')}}">Partidos</a></li>
    <li class="active">Mostrar Partidos</li>
</ul>

{% endblock%}

{% block sidecontent %}

<input id="game-id" type="hidden" value="{{game.id}}">

<div class="row margin-top-20">
    <div class="col-xs-12">
        <div class="well bs-component">
            <legend>Info de Partido</legend>
            <div class="row">
                <div class="col-xs-12">
                    <div class="row text-center">
                        <label>Lugar</label>
                    </div>
                    <div class="row text-center" >
                        <div id="map_canvas"></div>             
                    </div>
                    <div class="row text-center" >
                        <p> {% if game.center is defined and game.center is not null%} {{game.center.name}} - {{game.center.address.address}} - {{game.center.address.city}} ({{game.center.address.province}}) {% endif%}</p>           
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12">
                    <div class="row text-center">
                        <label>Límite de Baja</label>                            
                    </div>
                    <div class="row text-center">
                            {{game.limitDate | date('d/m/Y')}} {{game.limitDate | date('H:i')}}
                    </div>                                                                                            
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12">
                    <div class="row text-center">
                        <label>Precio</label>
                    </div>
                    <div class="row text-center" >
                              {{game.price }} €
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12">
                    <div class="row text-center">
                        <label>Organizado por</label>
                    </div>
                    <div class="row text-center" >
                        <img src="https://ssl.gstatic.com/accounts/ui/avatar_2x.png" style="height: 40px; width: 40px; margin-right: 10px;"> {{game.admin.name }}
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block maincontent %}
<div class="page-header">
    <h1 class="text-center">{{ game.sport.name }}</h1>
    <h2 class="text-center">{{game.gameDate | date('d/m/Y')}} a las {{game.gameDate | date('H:i')}} </h2>
</div>
<blockquote class="margin-top-20">
    <p> {{game.description }}</p>
</blockquote>  

<div class="row margin-top-20">
    <div class="col-xs-12">
        <div class="well">
            <h4>Jugadores Inscritos <span class="counter">({{game.players | length + 1 }} /{{game.numPlayers }})</span></h4>
            <div class="row players">
                <div class="col-xs-4 user">
                    <img src="https://ssl.gstatic.com/accounts/ui/avatar_2x.png" style="height: 40px; width: 40px; margin-right: 10px;">
                    {{game.admin.name}} (Admin)
                </div>
                {% for player in game.players %}
                <div class="col-xs-4 user" data-id="{{player.id}}" id="{{player.id}}">
                    <img src="https://ssl.gstatic.com/accounts/ui/avatar_2x.png" style="height: 40px; width: 40px; margin-right: 10px;">
                    {{player.name}}
                </div>
                {% endfor%}
                {% if not app.user in game.players and not app.user == game.admin%}
                <div class="margin-top-20">
                    <a href="" class="btn btn-success">Inscríbete</a>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="actions">
        {% if game.players.contains(app.user)%}
                <a href="#" class="btn btn-danger action-unsubscribe"> <i class="fa fa-minus"></i> Desinscribirse </a>
            {%elseif not game.isFull%}
                <a href="#" class="btn btn-success action-subscribe"> <i class="fa fa-plus"></i> Inscribirse </a>
            {% endif%}
        </div>
    </div>

    <div class="col-xs-12" style="display: none;">
        <div class="row">
            <h2>Comentarios</h2>
        </div>
        <div class="row">
            <input type="textarea" />
            <input type="submit" value="Enviar Comentario" class="btn btn-succes">
        </div>
            {% for i in 1..5 %}
        <div class="qa-message-list" id="wallmessages">
            <div class="message-item" id="m16">
                <div class="message-inner">
                    <div class="message-head clearfix">
                        <div class="avatar pull-left"><a href=""><img src="https://ssl.gstatic.com/accounts/ui/avatar_2x.png" style="height: 40px"></a></div>
                        <div class="user-detail">
                            <h5 class="handle">Oleg Kolesnichenko</h5>
                            <div class="post-meta">
                                <div class="asker-meta">
                                    <span class="qa-message-what"></span>
                                    <span class="qa-message-when">
                                        <span class="qa-message-when-data">Jan 21</span>
                                    </span>
                                    <span class="qa-message-who">
                                        <span class="qa-message-who-pad">by </span>
                                        <span class="qa-message-who-data"><a href="./index.php?qa=user&qa_1=Oleg+Kolesnichenko">Oleg Kolesnichenko</a></span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="qa-message-content">
                        Mensaje
                    </div>
                </div>

            </div>
        </div>
            {% endfor %}
    </div>
</div>

<script>
    function initialize() {
        var geocoder = new google.maps.Geocoder();
        var infowindow = new google.maps.InfoWindow();
        var position = new google.maps.LatLng({{game.center.address.lat}}, {{game.center.address.long}});

        var mapOptions = {
            zoom: 16,
            center: position,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        var map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);

        var marker = new google.maps.Marker({
            map: map,
            position: map.getCenter()
        });
    }

    function loadScript() {
        var script = document.createElement("script");
        script.type = "text/javascript";
        script.src = "http://maps.googleapis.com/maps/api/js?sensor=false&region=ES&language=es&callback=initialize";
        document.body.appendChild(script);
    }

    window.onload = loadScript;
    
     $(document).ready(function() {
        $(document).on("click", '.action-subscribe', function(event) {
            event.preventDefault();
            var id=$('#game-id').val();
            
            $.ajax({
                method: "GET",
                url: "{{path('intranet_ajax_subscribe_game')}}",
                dataType: "json",
                data: {
                    game: id
                },
                success: function(data) {
                   var button=$('.action-subscribe');
                    button.removeClass('action-subscribe');
                    button.removeClass('btn-success');
                    button.addClass('action-unsubscribe');
                    button.addClass('btn-danger');
                    button.html('<i class="fa fa-minus"></i> Desinscribirse')
                     $('.counter').html(data.places);
                     var obj = JSON.parse(data.user);
                     $('.players').append('<div class="col-xs-4 user" data-id="'+obj.id+'" id="'+obj.id+'"><img src="https://ssl.gstatic.com/accounts/ui/avatar_2x.png" style="height: 40px; width: 40px; margin-right: 10px;">'+obj.username+'</div>')
     
                }
            });
        });
        
         $(document).on("click", '.action-unsubscribe', function(event) {
            event.preventDefault();
             var id=$('#game-id').val();
            $.ajax({
                method: "GET",
                url: "{{path('intranet_ajax_unsubscribe_game')}}",
                dataType: "json",
                data: {
                    game: id
                },
                success: function(data) {
                    var button=$('.action-unsubscribe');
                    button.removeClass('action-unsubscribe');
                    button.removeClass('btn-danger');
                    button.addClass('action-subscribe');
                    button.addClass('btn-success');                
                    button.html('<i class="fa fa-plus"></i> Inscribirse')
                    $('.counter').html(data.places);
                    var obj = JSON.parse(data.user);
                    var userContent=$('.user[data-id='+obj.id+']');
                    userContent.hide(500);
                    userContent.remove();
                }
            });
        });
    });
</script>
</script>

{% endblock %}